<!DOCTYPE html>
<html>
<head>
        <!-- Element Imports -->
        <link href="../bower_components/polymer/polymer.html" rel="import">
        <link href="../bower_components/iron-ajax/iron-ajax.html" rel="import">
        <link href="../bower_components/paper-datatable/paper-datatable.html" rel="import">
</head>

<dom-module id="schedule-match">
    <style>
    </style>
    <template>
        <iron-ajax
            id="ajax"
            url="../data.json"
            handle-as="json"
            on-response="handleResponse"
            last-response="{{data}}"></iron-ajax>
        <paper-datatable data="{{participants}}" id="standings">
            <paper-datatable-column header="Rank" property="rank" sortable sort-direction="asc">
                <template>
                    <span>{{value}}</span>
                </template>
            </paper-datatable-column>
            <paper-datatable-column header="Clan" property="name" sortable>
                <template>
                    <span>{{value}}</span>
                </template>
            </paper-datatable-column>
            <paper-datatable-column header="Puntos" property="score" sortable>
                <template>
                    <span>{{value}}</span>
                </template>
            </paper-datatable-column>
        </paper-datatable>
        <template is="dom-if" if="{{participants}}" id="test">
        </template>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'schedule-match',
        properties: {
            participants: {
                type: Array,
                value: []
            },
            participantsTemp: {
                type: Array,
                value: []
            },
            data: {
                type: Object
            }
        },
        handleResponse: function() {
            var self = this;
            var data = this.data;
            var matches = data.tournament.matches;
            var participants = [];
            var scores = [];

            function addPoints(element, index, array) {
                if(element.match.state === 'complete') {
                    var score = element.match.scores_csv.split('-');
                    var ID1 = element.match.player1_id;
                    var ID2 = element.match.player2_id;

                    scores[ID1] = (scores[ID1] === undefined) ? Number(score[0]) : scores[ID1] + Number(score[0]);
                    scores[ID2] = (scores[ID2] === undefined) ? Number(score[1]) : scores[ID2] + Number(score[1]);
                }
            }

            function sortPositions(a, b) {
                return a.score > b.score ? -1 : 1;
            }

            matches.find(addPoints);

            for(var i = 0; i < data.tournament.participants.length; i++) {
                var tempParticipant = data.tournament.participants[i].participant;
                scores[tempParticipant.id] = (scores[tempParticipant.id] === undefined) ? 0 : scores[tempParticipant.id];

                participants.push({
                    'id': tempParticipant.id,
                    'name': tempParticipant.display_name,
                    'score': scores[tempParticipant.id]
                });
            }

            participants.sort(sortPositions);

            for(var i = 0; i < data.tournament.participants.length; i++) {
                if(i + 1 < 10) {
                    participants[i].rank = '#0' + (i + 1);
                } else {
                    participants[i].rank = '#' + (i + 1);
                }
            }

            self.participants = participants;
        },
        ready: function() {
            this.$.ajax.generateRequest();
        }
    });
</script>